<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBBasic Real-time Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
        <style>
            .card { transition: transform 0.3s; }
            .card:hover { transform: translateY(-5px); }
        </style>
</head>
<body>
    
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">DBBasic Monitor</a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="http://localhost:8005">Dashboard</a> <a class="nav-link" href="http://localhost:8005">Data</a> <a class="nav-link" href="http://localhost:8003">AI Services</a> <a class="nav-link" href="http://localhost:8005/templates">Templates</a>
                </div>
            </div>
        </nav><div class="container-fluid"><div class="text-center mb-4"><h1 class="display-4"><i class="bi bi-activity text-success"></i> Real-time Monitor</h1><span class="badge bg-success rounded-pill">âš¡ 402M rows/sec</span></div>
        <div class="container my-5">
            <div class="row row-cols-1 row-cols-md-4 g-4">
                <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">Operations/sec</h5>
                    
                </div>
                <p class="card-text"><h2 id="opsPerSec" class="text-primary">0</h2></p>
            </div>
            
        </div></div> <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">Active Services</h5>
                    
                </div>
                <p class="card-text"><h2 id="activeServices" class="text-success">0</h2></p>
            </div>
            
        </div></div> <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">Total Operations</h5>
                    
                </div>
                <p class="card-text"><h2 id="totalOps" class="text-info">0</h2></p>
            </div>
            
        </div></div> <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">Connected Clients</h5>
                    
                </div>
                <p class="card-text"><h2 id="connectedClients" class="text-warning">0</h2></p>
            </div>
            
        </div></div>
            </div>
        </div><div class="row mt-4"><div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">ðŸ“¡ Live Service Calls</h5>
                    
                </div>
                <p class="card-text"></p>
            </div>
            
        </div></div><div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">ðŸ’¾ Database Operations</h5>
                    
                </div>
                <p class="card-text"></p>
            </div>
            
        </div></div></div><div class="mt-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title">ðŸ“Š Table Activity</h5>
                    
                </div>
                <p class="card-text"></p>
            </div>
            
        </div></div><div class="mt-4 text-center"><div id="connectionStatus" class="badge bg-secondary">Connecting...</div></div>
                    <script>
                    let ws = null;
                    let reconnectInterval = null;

                    function connectWebSocket() {
                        ws = new WebSocket('ws://localhost:8004/ws');

                        ws.onopen = function() {
                            document.getElementById('connectionStatus').className = 'badge bg-success';
                            document.getElementById('connectionStatus').textContent = 'ðŸŸ¢ Connected';
                            clearInterval(reconnectInterval);
                        };

                        ws.onmessage = function(event) {
                            const data = JSON.parse(event.data);

                            if (data.type === 'metrics') {
                                updateMetrics(data.data);
                            } else if (data.type === 'service_call') {
                                addServiceCall(data.data);
                            } else if (data.type === 'db_operation') {
                                addDbOperation(data.data);
                            }
                        };

                        ws.onclose = function() {
                            document.getElementById('connectionStatus').className = 'badge bg-danger';
                            document.getElementById('connectionStatus').textContent = 'ðŸ”´ Disconnected';

                            // Attempt to reconnect every 3 seconds
                            if (!reconnectInterval) {
                                reconnectInterval = setInterval(connectWebSocket, 3000);
                            }
                        };

                        ws.onerror = function(error) {
                            console.error('WebSocket error:', error);
                        };
                    }

                    function updateMetrics(metrics) {
                        document.getElementById('opsPerSec').textContent =
                            metrics.operations_per_second ? metrics.operations_per_second.toLocaleString() : '0';
                        document.getElementById('activeServices').textContent =
                            metrics.active_services || '0';
                        document.getElementById('totalOps').textContent =
                            metrics.total_operations ? metrics.total_operations.toLocaleString() : '0';
                        document.getElementById('connectedClients').textContent =
                            metrics.active_connections || '0';
                    }

                    function addServiceCall(data) {
                        const feed = document.getElementById('serviceCalls');
                        const entry = document.createElement('div');
                        entry.className = 'alert alert-info py-2 mb-2';
                        entry.innerHTML = `
                            <small class="text-muted">${new Date(data.timestamp).toLocaleTimeString()}</small><br>
                            <strong>${data.service}</strong>: ${data.result}
                        `;
                        feed.insertBefore(entry, feed.firstChild);

                        // Keep only last 20 entries
                        while (feed.children.length > 20) {
                            feed.removeChild(feed.lastChild);
                        }
                    }

                    function addDbOperation(data) {
                        const feed = document.getElementById('dbOperations');
                        const entry = document.createElement('div');
                        entry.className = 'alert alert-success py-2 mb-2';
                        entry.innerHTML = `
                            <small class="text-muted">${new Date(data.timestamp).toLocaleTimeString()}</small><br>
                            <strong>${data.operation}</strong> on ${data.table}: ${data.count} rows
                        `;
                        feed.insertBefore(entry, feed.firstChild);

                        // Update table stats
                        if (data.table) {
                            const opsElement = document.getElementById(data.table + '-ops');
                            if (opsElement) {
                                const current = parseInt(opsElement.textContent) || 0;
                                opsElement.textContent = (current + 1).toLocaleString();
                            }

                            const rateElement = document.getElementById(data.table + '-rate');
                            if (rateElement) {
                                rateElement.textContent = data.rate ? data.rate.toLocaleString() : '0';
                            }
                        }

                        // Keep only last 20 entries
                        while (feed.children.length > 20) {
                            feed.removeChild(feed.lastChild);
                        }
                    }

                    // Connect on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        connectWebSocket();
                    });
                    </script>
                    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
        <script>
            function deployTemplate(id) { alert('Deploying: ' + id); }
            function previewTemplate(id) { alert('Preview: ' + id); }
        </script>
</body>
</html>